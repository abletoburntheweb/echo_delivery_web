<!-- templates/core/admin_menu.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω –ú–µ–Ω—é | ECHO Corp.</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'core/css/admin_menu.css' %}">
</head>
<body>
    <div class="header">
        <span class="header-title">ECHO Corp.</span>
        <div class="header-buttons">
            <a href="{% url 'profile' %}" class="profile-button user-icon">üë§</a>
            <a href="{% url 'admin:index' %}" class="profile-button admin-icon">‚öôÔ∏è</a>
        </div>
    </div>
    <div class="full-screen-menu">
        <!-- –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å" -->
        <button class="add-dish-btn" onclick="openAddDishModal()">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</button>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫...">
            <button class="search-btn">üîç</button>
        </div>

        <div class="main-content">
            <!-- –°–∞–π–¥–±–∞—Ä —Å–ª–µ–≤–∞ -->
            <div class="sidebar">
                <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                <ul id="category-list">
                    <!-- "–í—Å–µ" –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                </ul>
                <div class="category-controls">
                    <button class="add-category-btn" onclick="addCategory()">+</button>
                    <button class="remove-category-btn" onclick="removeCategory()">-</button>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–ø—Ä–∞–≤–∞ -->
            <div class="content-area">
                <div class="menu-grid" id="dish-grid">
                    <!-- –ë–ª—é–¥–∞ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
    {% include 'core/partials/modal_category.html' %}

    <!-- –ù–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞ -->
    <div id="addDishModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª—é–¥–∞</span>
                <button class="close" onclick="closeAddDishModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addDishForm">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="newDishName">–ò–º—è –±–ª—é–¥–∞:</label>
                        <input type="text" id="newDishName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="newDishDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="newDishDescription" name="description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newDishPrice">–¶–µ–Ω–∞:</label>
                        <input type="number" id="newDishPrice" name="price" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="newDishCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                        <select id="newDishCategory" name="category_id" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                            <!-- –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newDishImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (URL):</label>
                        <input type="url" id="newDishImage" name="image" required>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="save-button">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        let currentCategoryId = null;

        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–∫–∞–∫ –±—ã–ª–æ) ---
        function openModal() {
            document.getElementById("myModal").style.display = "block";
        }

        function closeModal() {
            document.getElementById("myModal").style.display = "none";
        }

        window.onclick = function(event) {
            const modal = document.getElementById("myModal");
            if (event.target === modal) {
                closeModal();
            }
        }

        function addCategory() {
            const newCategoryName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:");
            if (newCategoryName && newCategoryName.trim() !== "") {
                console.log("–ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", newCategoryName);
                const categoryList = document.getElementById("category-list");
                const li = document.createElement("li");
                li.innerHTML = `<span>${newCategoryName}</span>`;
                li.dataset.categoryId = "new_" + newCategoryName;
                li.addEventListener('click', function() {
                    selectCategory(this.dataset.categoryId, this.querySelector('span').textContent);
                });
                categoryList.appendChild(li);
                // –û–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –≤ —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞
                updateCategoryOptions();
                // –í—ã–±–µ—Ä–µ–º –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
                selectCategory(li.dataset.categoryId, newCategoryName);
            }
        }

        function removeCategory() {
            const categoryList = document.getElementById("category-list");
            const selectedLi = Array.from(categoryList.children).find(li => li.classList.contains('selected'));
            if (!selectedLi) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.");
                return;
            }
            console.log("–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å ID:", selectedLi.dataset.categoryId);
            if (confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ —É–¥–∞–ª—è–µ—Ç –±–ª—é–¥–∞.")) {
                 selectedLi.remove();
                 // –û–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –≤ —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞
                 updateCategoryOptions();
                 // –°–±—Ä–æ—Å–∏–º –≤—ã–±–æ—Ä
                 currentCategoryId = null;
                 // –û–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫ –±–ª—é–¥ (–ø–æ–∫–∞–∂–µ–º –≤—Å–µ, –µ—Å–ª–∏ "–í—Å–µ" –≤—ã–±—Ä–∞–Ω–æ, –∏–ª–∏ –æ—á–∏—Å—Ç–∏–º)
                 if (document.querySelector('#category-list li[data-category-id="all"]').classList.contains('selected')) {
                     loadDishes(); // –ü–æ–∫–∞–∂–µ–º –≤—Å–µ –±–ª—é–¥–∞
                 } else {
                     loadDishes(); // –ü–æ–∫–∞–∂–µ–º –≤—Å–µ –±–ª—é–¥–∞, —Ç–∞–∫ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –±–æ–ª—å—à–µ –Ω–µ—Ç
                 }
            }
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª—é–¥ ---
        function selectCategory(categoryId, categoryName) {
            const categoryItems = document.querySelectorAll("#category-list li");
            categoryItems.forEach(item => item.classList.remove('selected'));

            const selectedItem = Array.from(categoryItems).find(item => item.dataset.categoryId === categoryId);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }

            currentCategoryId = categoryId;
            loadDishes(categoryId, categoryName);
        }

        function loadDishes(categoryId = null, categoryName = '') {
            const dishGrid = document.getElementById("dish-grid");
            dishGrid.innerHTML = '';

            if (categoryId && categoryId !== 'all') {
                dishGrid.innerHTML = `<p>–ó–∞–≥—Ä—É–∑–∫–∞ –±–ª—é–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryName}"...</p>`;
                const filteredDishes = allDishes.filter(dish => dish.categoryId == categoryId);
                renderDishes(filteredDishes);
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –±–ª—é–¥–∞ –¥–ª—è "–í—Å–µ" –∏–ª–∏ –µ—Å–ª–∏ categoryId null
                dishGrid.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –±–ª—é–¥...</p>';
                renderDishes(allDishes);
            }
        }

        function renderDishes(dishes) {
            const dishGrid = document.getElementById("dish-grid");
            dishGrid.innerHTML = '';
            if (dishes.length === 0) {
                dishGrid.innerHTML = '<p>–ù–µ—Ç –±–ª—é–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>';
            } else {
                dishes.forEach(dish => {
                    const dishCard = document.createElement('a');
                    dishCard.href = "{% url 'admin_dish_detail' 0 %}".replace('0', dish.id);
                    dishCard.className = 'dish-card-link';

                    const card = document.createElement('div');
                    card.className = 'dish-card';

                    const img = document.createElement('img');
                    img.src = dish.image;
                    img.alt = dish.name;
                    img.className = 'dish-image';

                    const info = document.createElement('div');
                    info.className = 'dish-info';

                    const name = document.createElement('h3');
                    name.className = 'dish-name';
                    name.textContent = dish.name;

                    const price = document.createElement('p');
                    price.className = 'dish-price';
                    price.textContent = `${dish.price}‚ÇΩ`;

                    info.appendChild(name);
                    info.appendChild(price);

                    card.appendChild(img);
                    card.appendChild(info);

                    dishCard.appendChild(card);
                    dishGrid.appendChild(dishCard);
                });
            }
        }

        // --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞ ---
        function openAddDishModal() {
            const modal = document.getElementById("addDishModal");
            modal.style.display = "flex";
            // –°–±—Ä–æ—Å–∏–º —Ñ–æ—Ä–º—É –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
            document.getElementById('addDishForm').reset();
        }

        function closeAddDishModal() {
            const modal = document.getElementById("addDishModal");
            modal.style.display = "none";
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        window.onclick = function(event) {
            const modal = document.getElementById("addDishModal");
            if (event.target === modal) {
                closeAddDishModal();
            }
            // –í—ã–∑–æ–≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const catModal = document.getElementById("myModal");
            if (event.target === catModal) {
                closeModal();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞
        document.getElementById('addDishForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞.
            // –ü–æ–∫–∞ —á—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ.
            console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–æ–≤–æ–≥–æ –±–ª—é–¥–∞:", Object.fromEntries(formData.entries()));

            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏:
            // fetch('{% url "add_dish" %}', { // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å —Ç–∞–∫–æ–π URL
            //     method: 'POST',
            //     body: formData
            // })
            // .then(response => response.json())
            // .then(data => {
            //     if (data.success) {
            //         closeAddDishModal();
            //         // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–ª—é–¥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å
            //         location.reload(); // –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            //     } else {
            //         // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫–∏
            //         alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–ª—é–¥–∞: ' + data.error);
            //     }
            // })
            // .catch(error => {
            //     console.error('–û—à–∏–±–∫–∞:', error);
            //     alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            // });

            // –ü–æ–∫–∞ —á—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            closeAddDishModal();
            // –ò–º–∏—Ç–∏—Ä—É–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–≤—Ä–µ–º–µ–Ω–Ω–æ)
            alert("–ë–ª—é–¥–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä).");
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
        });

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        // –î–∞–Ω–Ω—ã–µ –æ –±–ª—é–¥–∞—Ö (–ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –∏–∑ Django)
        const allDishes = [
            {% for dish in dishes %}
                {
                    id: {{ dish.id }},
                    name: "{{ dish.name|escapejs }}",
                    price: {{ dish.price }},
                    image: "{{ dish.image|escapejs }}",
                    categoryId: {{ dish.category.id }}
                },
            {% endfor %}
        ];

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–π –≤ —Å–µ–ª–µ–∫—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ —Ñ–æ—Ä–º–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞
        function updateCategoryOptions() {
            const selectElement = document.getElementById('newDishCategory');
            // –û—á–∏—Å—Ç–∏–º —Ç–µ–∫—É—â–∏–µ –æ–ø—Ü–∏–∏ (–∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π "–í—ã–±–µ—Ä–∏—Ç–µ...")
            selectElement.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';

            const categories = Array.from(document.querySelectorAll("#category-list li")).filter(li => li.dataset.categoryId !== 'all');
            categories.forEach(li => {
                const option = document.createElement("option");
                option.value = li.dataset.categoryId;
                option.textContent = li.querySelector('span').textContent;
                selectElement.appendChild(option);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–≥—Ä—É–∑–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–º + "–í—Å–µ"
            const categoryList = document.getElementById("category-list");

            // –î–æ–±–∞–≤–∏–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–í—Å–µ"
            const allLi = document.createElement("li");
            allLi.innerHTML = `<span>–í—Å–µ</span>`;
            allLi.dataset.categoryId = "all";
            allLi.dataset.categoryName = "–í—Å–µ"; // –î–æ–±–∞–≤–∏–º –∏–º—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
            allLi.addEventListener('click', function() {
                selectCategory(this.dataset.categoryId, this.dataset.categoryName);
            });
            categoryList.appendChild(allLi);

            // –ó–∞–≥—Ä—É–∑–∏–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const categories = [
                {% for cat in categories %}
                    { id: {{ cat.id }}, name: "{{ cat.name|escapejs }}" },
                {% endfor %}
            ];

            categories.forEach(cat => {
                const li = document.createElement("li");
                li.innerHTML = `<span>${cat.name}</span>`;
                li.dataset.categoryId = cat.id;
                li.dataset.categoryName = cat.name;
                li.addEventListener('click', function() {
                    selectCategory(this.dataset.categoryId, this.dataset.categoryName);
                });
                categoryList.appendChild(li);
            });

            // –û–±–Ω–æ–≤–∏–º –æ–ø—Ü–∏–∏ –≤ —Å–µ–ª–µ–∫—Ç–µ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞
            updateCategoryOptions();

            // –ó–∞–≥—Ä—É–∑–∏–º –≤—Å–µ –±–ª—é–¥–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–∫–∞—Ç–µ–≥–æ—Ä–∏—è "–í—Å–µ" –≤—ã–±—Ä–∞–Ω–∞)
            selectCategory("all", "–í—Å–µ");
        });
    </script>
</body>
</html>