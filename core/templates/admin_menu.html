<!-- templates/core/admin_menu.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω –ú–µ–Ω—é | ECHO Corp.</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'core/css/a_admin.css' %}?v=5">
</head>
<body>
    <div class="header">
        <span class="header-title">ECHO Corp.</span>
        <div class="header-buttons">
            <a href="{% url 'admin_logout' %}" class="profile-button">üö™</a>
            <a href="{% url 'admin_calendar' %}" class="unused-button">üìÖ</a>
            <a href="{% url 'admin_panel' %}" class="profile-button">üìã</a>
        </div>
    </div>

    <div class="main-content">
        <div class="container menu-container">
            <h2 class="panel-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏</h2>

            <div class="categories-panel">
                <button class="add-category-btn panel-button">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                <ul class="categories-list">
                    {% for category in categories %}
                        <li class="category-item" data-category-id="{{ category.id_cat }}">
                            {{ category.name }}
                            <span class="category-actions">
                                <button class="edit-category-btn">‚úèÔ∏è</button>
                                <button class="delete-category-btn">üóëÔ∏è</button>
                            </span>
                        </li>
                    {% endfor %}
                </ul>
            </div>

            <div class="dishes-panel">
                <div class="dishes-header">
                    <input type="text" id="search-dish" placeholder="–ü–æ–∏—Å–∫..." class="search-input">
                    <button class="add-dish-btn panel-button">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</button>
                </div>

                <div class="dishes-grid">
                    {% for dish in dishes %}
                        <div class="dish-card" data-dish-id="{{ dish.id_blu }}" data-category-id="{{ dish.category.id_cat }}">
                            <img src="{{ dish.image.url }}" alt="{{ dish.name }}" class="dish-image">
                            <div class="dish-info">
                                <div class="dish-name">{{ dish.name }}</div>
                                <div class="dish-price">{{ dish.price }} ‚ÇΩ</div>
                            </div>
                            <div class="dish-actions">
                                <button class="edit-dish-btn">‚úèÔ∏è</button>
                                <button class="delete-dish-btn">üóëÔ∏è</button>
                            </div>
                        </div>
                    {% empty %}
                        <p style="text-align: center; color: #666;">–ù–µ—Ç –±–ª—é–¥ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div id="add-category-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
            <form id="add-category-form">
                {% csrf_token %}
                <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" required>
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <div id="add-dish-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3>–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</h3>
            <form id="add-dish-form" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞" required>
                <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                <input type="number" name="price" step="0.01" placeholder="–¶–µ–Ω–∞" required>
                <select name="category_id" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                    {% for category in categories %}
                        <option value="{{ category.id_cat }}">{{ category.name }}</option>
                    {% endfor %}
                </select>
                <input type="file" name="image" accept="image/*" required>
                <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –±–ª—é–¥ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        function loadDishesByCategory(categoryId) {
            fetch(`/admin/dish/list/?category_id=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    const dishesGrid = document.querySelector('.dishes-grid');
                    if (data.success) {
                        dishesGrid.innerHTML = '';
                        data.dishes.forEach(dish => {
                            const dishCard = document.createElement('div');
                            dishCard.className = 'dish-card';
                            dishCard.dataset.dishId = dish.id;
                            dishCard.dataset.categoryId = dish.category_id;
                            dishCard.innerHTML = `
                                <img src="${dish.image}" alt="${dish.name}" class="dish-image">
                                <div class="dish-info">
                                    <div class="dish-name">${dish.name}</div>
                                    <div class="dish-price">${dish.price} ‚ÇΩ</div>
                                </div>
                                <div class="dish-actions">
                                    <button class="edit-dish-btn">‚úèÔ∏è</button>
                                    <button class="delete-dish-btn">üóëÔ∏è</button>
                                </div>
                            `;
                            dishesGrid.appendChild(dishCard);
                        });
                    } else {
                        dishesGrid.innerHTML = `<p style="text-align: center; color: #666;">${data.error}</p>`;
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–ª—é–¥:', error);
                });
        }

        // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –±–ª—é–¥–∞ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        document.addEventListener('DOMContentLoaded', function() {
            const categoryItems = document.querySelectorAll('.category-item');
            const addCategoryBtn = document.querySelector('.add-category-btn');
            const addDishBtn = document.querySelector('.add-dish-btn');
            const searchInput = document.getElementById('search-dish');

            categoryItems.forEach(item => {
                item.addEventListener('click', function() {
                    const categoryId = this.dataset.categoryId;
                    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                    categoryItems.forEach(i => i.classList.remove('active'));
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –∫ —Ç–µ–∫—É—â–µ–π
                    this.classList.add('active');
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–ª—é–¥–∞
                    loadDishesByCategory(categoryId);
                });
            });

            // –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é"
            addCategoryBtn.addEventListener('click', function() {
                document.getElementById('add-category-modal').style.display = 'block';
            });

            // –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ"
            addDishBtn.addEventListener('click', function() {
                document.getElementById('add-dish-modal').style.display = 'block';
            });

            // –ü–æ–∏—Å–∫ –±–ª—é–¥
            searchInput.addEventListener('input', function() {
                const query = this.value.trim().toLowerCase();
                const dishCards = document.querySelectorAll('.dish-card');
                dishCards.forEach(card => {
                    const name = card.querySelector('.dish-name').textContent.toLowerCase();
                    card.style.display = name.includes(query) ? 'block' : 'none';
                });
            });

            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            document.querySelectorAll('.close-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    this.closest('.modal').style.display = 'none';
                });
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            document.getElementById('add-category-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch('{% url "add_category" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞.');
                        location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
                    } else {
                        alert(data.error);
                    }
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.');
                });
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª—é–¥–∞
            document.getElementById('add-dish-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch('{% url "add_dish" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('–ë–ª—é–¥–æ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ.');
                        location.reload();
                    } else {
                        alert(data.error);
                    }
                })
                .catch(error => {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–ª—é–¥–∞.');
                });
            });

            // –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-category-btn')) {
                    const categoryId = e.target.closest('.category-item').dataset.categoryId;
                    if (confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
                        fetch('{% url "delete_category" %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            },
                            body: JSON.stringify({ category_id: categoryId })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞.');
                                location.reload();
                            } else {
                                alert(data.error);
                            }
                        })
                        .catch(error => {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.');
                        });
                    }
                }
            });

            // –£–¥–∞–ª–µ–Ω–∏–µ –±–ª—é–¥–∞
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('delete-dish-btn')) {
                    const dishId = e.target.closest('.dish-card').dataset.dishId;
                    if (confirm('–£–¥–∞–ª–∏—Ç—å –±–ª—é–¥–æ?')) {
                        fetch(`/admin/dish/delete/${dishId}/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('–ë–ª—é–¥–æ —É–¥–∞–ª–µ–Ω–æ.');
                                location.reload();
                            } else {
                                alert(data.error);
                            }
                        })
                        .catch(error => {
                            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–ª—é–¥–∞.');
                        });
                    }
                }
            });

            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–ª—é–¥–∞ (–ø–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('edit-dish-btn')) {
                    const dishId = e.target.closest('.dish-card').dataset.dishId;
                    window.location.href = `{% url 'update_dish' 0 %}`.replace('0', dishId);
                }
            });
        });
    </script>
</body>
</html>