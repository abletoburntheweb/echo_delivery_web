<!-- templates/core/admin_menu.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω –ú–µ–Ω—é | ECHO Corp.</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'core/css/admin_menu.css' %}">
</head>
<body>
    <div class="header">
        <span class="header-title">ECHO Corp.</span>
        <div class="header-buttons">
            <a href="{% url 'profile' %}" class="profile-button user-icon">üë§</a>
            <a href="{% url 'admin:index' %}" class="profile-button admin-icon">‚öôÔ∏è</a>
        </div>
    </div>
    <div class="full-screen-menu">
        <button class="add-dish-btn" onclick="openAddDishModal()">–î–æ–±–∞–≤–∏—Ç—å –±–ª—é–¥–æ</button>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫...">
            <button class="search-btn">üîç</button>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                <ul id="category-list">
                </ul>
                <div class="category-controls">
                    <button class="add-category-btn" onclick="addCategory()">+</button>
                    <button class="remove-category-btn" onclick="removeCategory()">-</button>
                </div>
            </div>

            <div class="content-area">
                <div class="menu-grid" id="dish-grid">
                </div>
            </div>
        </div>
    </div>


    <div id="addDishModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–ª—é–¥–∞</span>
                <button class="close" onclick="closeAddDishModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addDishForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="newDishName">–ò–º—è –±–ª—é–¥–∞:</label>
                        <input type="text" id="newDishName" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="newDishDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
                        <textarea id="newDishDescription" name="description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newDishPrice">–¶–µ–Ω–∞:</label>
                        <input type="number" id="newDishPrice" name="price" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="newDishCategory">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
                        <select id="newDishCategory" name="category_id" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newDishImage">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
                        <input type="file" id="newDishImage" name="image" accept="image/*">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="save-button">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentCategoryId = null;

        function addCategory() {
            const newCategoryName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:");
            if (newCategoryName && newCategoryName.trim() !== "") {
                fetch("{% url 'add_category' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Accept': 'application/json'
                    },
                    body: new URLSearchParams({
                        'name': newCategoryName.trim()
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const categoryList = document.getElementById("category-list");
                        const li = document.createElement("li");
                        li.innerHTML = `<span>${data.category.name}</span>`;
                        li.dataset.categoryId = data.category.id;
                        li.addEventListener('click', function() {
                            selectCategory(this.dataset.categoryId, this.querySelector('span').textContent);
                        });
                        categoryList.appendChild(li);
                        updateCategoryOptions();
                        selectCategory(data.category.id, data.category.name);
                    } else {
                        alert("–û—à–∏–±–∫–∞: " + data.error);
                    }
                })
                .catch(err => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", err);
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
                });
            }
        }

        function removeCategory() {
            const categoryList = document.getElementById("category-list");
            const selectedLi = Array.from(categoryList.children).find(li => li.classList.contains('selected'));

            if (!selectedLi) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.");
                return;
            }

            const categoryId = selectedLi.dataset.categoryId;

            if (categoryId === 'all') {
                alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é '–í—Å–µ'.");
                return;
            }

            if (confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ —É–¥–∞–ª—è–µ—Ç –±–ª—é–¥–∞.")) {
                fetch("{% url 'delete_category' %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Accept': 'application/json'
                    },
                    body: new URLSearchParams({
                        'category_id': categoryId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        selectedLi.remove();
                        updateCategoryOptions();
                        currentCategoryId = null;
                        if (document.querySelector('#category-list li[data-category-id="all"]').classList.contains('selected')) {
                            loadDishes();
                        } else {
                            loadDishes();
                        }
                    } else {
                        alert("–û—à–∏–±–∫–∞: " + data.error);
                    }
                })
                .catch(err => {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", err);
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.");
                });
            }
        }

        function selectCategory(categoryId, categoryName) {
            const categoryItems = document.querySelectorAll("#category-list li");
            categoryItems.forEach(item => item.classList.remove('selected'));

            const selectedItem = Array.from(categoryItems).find(item => item.dataset.categoryId === categoryId);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }

            currentCategoryId = categoryId;
            loadDishes(categoryId, categoryName);
        }

        function loadDishes(categoryId = null, categoryName = '') {
            const dishGrid = document.getElementById("dish-grid");
            dishGrid.innerHTML = '';

            if (categoryId && categoryId !== 'all') {
                dishGrid.innerHTML = `<p>–ó–∞–≥—Ä—É–∑–∫–∞ –±–ª—é–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryName}"...</p>`;
                const filteredDishes = allDishes.filter(dish => dish.categoryId == categoryId);
                renderDishes(filteredDishes);
            } else {
                dishGrid.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –±–ª—é–¥...</p>';
                renderDishes(allDishes);
            }
        }

        function renderDishes(dishes) {
            const dishGrid = document.getElementById("dish-grid");
            dishGrid.innerHTML = '';
            if (dishes.length === 0) {
                dishGrid.innerHTML = '<p>–ù–µ—Ç –±–ª—é–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</p>';
            } else {
                dishes.forEach(dish => {
                    const dishCard = document.createElement('a');
                    dishCard.href = "{% url 'admin_dish_detail' 0 %}".replace('0', dish.id);
                    dishCard.className = 'dish-card-link';

                    const card = document.createElement('div');
                    card.className = 'dish-card';

                    const img = document.createElement('img');
                    img.src = dish.image;
                    img.alt = dish.name;
                    img.className = 'dish-image';

                    const info = document.createElement('div');
                    info.className = 'dish-info';

                    const name = document.createElement('h3');
                    name.className = 'dish-name';
                    name.textContent = dish.name;

                    const price = document.createElement('p');
                    price.className = 'dish-price';
                    price.textContent = `${dish.price}‚ÇΩ`;

                    info.appendChild(name);
                    info.appendChild(price);

                    card.appendChild(img);
                    card.appendChild(info);

                    dishCard.appendChild(card);
                    dishGrid.appendChild(dishCard);
                });
            }
        }

        function openAddDishModal() {
            const modal = document.getElementById("addDishModal");
            modal.style.display = "flex";
            document.getElementById('addDishForm').reset();
        }

        function closeAddDishModal() {
            const modal = document.getElementById("addDishModal");
            modal.style.display = "none";
        }

        window.onclick = function(event) {
            const modal = document.getElementById("addDishModal");
            if (event.target === modal) {
                closeAddDishModal();
            }
        }

        document.getElementById('addDishForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            fetch('{% url "add_dish" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeAddDishModal();
                    location.reload();
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –±–ª—é–¥–∞: ' + (data.errors ? data.errors.join(", ") : data.error));
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É.');
            });
        });

        const allDishes = [
            {% for dish in dishes %}
                {
                    id: {{ dish.id_dish }},
                    name: "{{ dish.name|escapejs }}",
                    price: {{ dish.price }},
                    image: "{{ dish.img|escapejs }}",
                    categoryId: {{ dish.id_category.id_category }}
                },
            {% endfor %}
        ];

        function updateCategoryOptions() {
            const selectElement = document.getElementById('newDishCategory');
            selectElement.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>';

            const categories = Array.from(document.querySelectorAll("#category-list li")).filter(li => li.dataset.categoryId !== 'all');
            categories.forEach(li => {
                const option = document.createElement("option");
                option.value = li.dataset.categoryId;
                option.textContent = li.querySelector('span').textContent;
                selectElement.appendChild(option);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const categoryList = document.getElementById("category-list");

            const allLi = document.createElement("li");
            allLi.innerHTML = `<span>–í—Å–µ</span>`;
            allLi.dataset.categoryId = "all";
            allLi.dataset.categoryName = "–í—Å–µ";
            allLi.addEventListener('click', function() {
                selectCategory(this.dataset.categoryId, this.dataset.categoryName);
            });
            categoryList.appendChild(allLi);

            const djangoCategories = [
                {% for cat in categories %}
                    { id_category: {{ cat.id_category }}, name: "{{ cat.name|escapejs }}" },
                {% endfor %}
            ];

            djangoCategories.forEach(cat => {
                const li = document.createElement("li");
                li.innerHTML = `<span>${cat.name}</span>`;
                li.dataset.categoryId = cat.id_category;
                li.dataset.categoryName = cat.name;
                li.addEventListener('click', function() {
                    selectCategory(this.dataset.categoryId, this.dataset.categoryName);
                });
                categoryList.appendChild(li);
            });

            updateCategoryOptions();

            selectCategory("all", "–í—Å–µ");
        });
    </script>
</body>
</html>