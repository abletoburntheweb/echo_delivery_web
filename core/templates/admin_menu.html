<!-- templates/core/admin_menu.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ê–¥–º–∏–Ω –ú–µ–Ω—é | ECHO Corp.</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'core/css/admin_menu.css' %}">
</head>
<body>
    <div class="header">
        <span class="header-title">ECHO Corp.</span>
        <div class="header-buttons">
            <a href="{% url 'profile' %}" class="profile-button user-icon">üë§</a>
            <a href="{% url 'admin:index' %}" class="profile-button admin-icon">‚öôÔ∏è</a>
        </div>
    </div>
    <div class="full-screen-menu">
        <button class="add-dish-btn" onclick="openModal()">–î–æ–±–∞–≤–∏—Ç—å</button>

        <div class="search-bar">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫...">
            <button class="search-btn">üîç</button>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
                <ul id="category-list">
                </ul>
                <div class="category-controls">
                    <button class="add-category-btn" onclick="addCategory()">+</button>
                    <button class="remove-category-btn" onclick="removeCategory()">-</button>
                </div>
            </div>

            <div class="content-area">
                <div class="menu-grid" id="dish-grid">
                </div>
            </div>
        </div>
    </div>

    {% include 'core/partials/modal_category.html' %}

    <script>
        let currentCategoryId = null;

        function openModal() {
            document.getElementById("myModal").style.display = "block";
        }

        function closeModal() {
            document.getElementById("myModal").style.display = "none";
        }

        window.onclick = function(event) {
            const modal = document.getElementById("myModal");
            if (event.target === modal) {
                closeModal();
            }
        }

        function addCategory() {
            const newCategoryName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:");
            if (newCategoryName && newCategoryName.trim() !== "") {
                console.log("–ü–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", newCategoryName);
                const categoryList = document.getElementById("category-list");
                const li = document.createElement("li");
                li.innerHTML = `<span>${newCategoryName}</span>`;
                li.dataset.categoryId = "new_" + newCategoryName;
                li.addEventListener('click', function() {
                    selectCategory(this.dataset.categoryId, this.querySelector('span').textContent);
                });
                categoryList.appendChild(li);
                selectCategory(li.dataset.categoryId, newCategoryName);
            }
        }

        function removeCategory() {
            const categoryList = document.getElementById("category-list");
            const selectedLi = Array.from(categoryList.children).find(li => li.classList.contains('selected'));
            if (!selectedLi) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.");
                return;
            }
            console.log("–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å ID:", selectedLi.dataset.categoryId);
            if (confirm("–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ —É–¥–∞–ª—è–µ—Ç –±–ª—é–¥–∞.")) {
                 selectedLi.remove();
                 currentCategoryId = null;
                 loadDishes();
            }
        }

        function selectCategory(categoryId, categoryName) {
            // –°–±—Ä–æ—Å–∏–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const categoryItems = document.querySelectorAll("#category-list li");
            categoryItems.forEach(item => item.classList.remove('selected'));

            const selectedItem = Array.from(categoryItems).find(item => item.dataset.categoryId === categoryId);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }

            currentCategoryId = categoryId;

            loadDishes(categoryId, categoryName);
        }

        function loadDishes(categoryId = null, categoryName = '') {
            const dishGrid = document.getElementById("dish-grid");
            dishGrid.innerHTML = '';

            if (categoryId) {
                dishGrid.innerHTML = `<p>–ó–∞–≥—Ä—É–∑–∫–∞ –±–ª—é–¥ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryName}"...</p>`;
            } else {
                dishGrid.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –±–ª—é–¥...</p>';
            }

            const allDishes = [
                {% for dish in dishes %}
                    {
                        id: {{ dish.id }},
                        name: "{{ dish.name|escapejs }}",
                        price: {{ dish.price }},
                        image: "{{ dish.image|escapejs }}",
                        categoryId: {{ dish.category.id }}
                    },
                {% endfor %}
            ];

            let filteredDishes = allDishes;
            if (categoryId) {
                filteredDishes = allDishes.filter(dish => dish.categoryId == categoryId);
            }

            dishGrid.innerHTML = '';
            if (filteredDishes.length === 0) {
                dishGrid.innerHTML = '<p>–ù–µ—Ç –±–ª—é–¥ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.</p>';
            } else {
                filteredDishes.forEach(dish => {
                    const dishCard = document.createElement('a');
                    dishCard.href = "{% url 'admin_dish_detail' 0 %}".replace('0', dish.id); // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º ID
                    dishCard.className = 'dish-card-link';

                    const card = document.createElement('div');
                    card.className = 'dish-card';

                    const img = document.createElement('img');
                    img.src = dish.image;
                    img.alt = dish.name;
                    img.className = 'dish-image';

                    const info = document.createElement('div');
                    info.className = 'dish-info';

                    const name = document.createElement('h3');
                    name.className = 'dish-name';
                    name.textContent = dish.name;

                    const price = document.createElement('p');
                    price.className = 'dish-price';
                    price.textContent = `${dish.price}‚ÇΩ`;

                    info.appendChild(name);
                    info.appendChild(price);

                    card.appendChild(img);
                    card.appendChild(info);

                    dishCard.appendChild(card);
                    dishGrid.appendChild(dishCard);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const categoryList = document.getElementById("category-list");
            const categories = [
                {% for cat in categories %}
                    { id: {{ cat.id }}, name: "{{ cat.name|escapejs }}" },
                {% endfor %}
            ];

            categories.forEach(cat => {
                const li = document.createElement("li");
                li.innerHTML = `<span>${cat.name}</span>`;
                li.dataset.categoryId = cat.id;
                li.addEventListener('click', function() {
                    selectCategory(this.dataset.categoryId, this.querySelector('span').textContent);
                });
                categoryList.appendChild(li);
            });

            loadDishes();
        });
    </script>
</body>
</html>