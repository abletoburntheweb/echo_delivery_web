<!-- templates/core/cart.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ—Ä–∑–∏–Ω–∞ | ECHO Corp.</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'core/css/cart.css' %}">
</head>
<body>
    <div class="header">
        <span class="header-title">ECHO Corp.</span>

        {% if work_dates.enabled and work_dates.display_text %}
        <div style="color: white; font-size: 14px; margin: 0 15px;">
            {{ work_dates.display_text }}
        </div>
        {% endif %}

        <div class="header-buttons">
            <span class="unused-button">üìÖ</span>
            <a href="{% url 'profile' %}" class="profile-button">üë§</a>
            <a href="{% url 'faq' %}" class="profile-button">‚ùì</a>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <h2 class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞ {{ item_count }} –ø–æ–∑–∏—Ü–∏–∏</h2>

            <a href="{% url 'menu' %}" class="add-item-btn">+</a>

            {% if cart_items %}
                <div class="cart-items">
                    {% for item in cart_items %}
                        <div class="cart-item">
                            <span class="item-name">{{ item.name }}</span>
                            <div class="quantity-controls">
                                <label for="quantity_{{ item.id }}">–ö–æ–ª-–≤–æ:</label>
                                <input type="number" id="quantity_{{ item.id }}" name="quantity" value="{{ item.quantity }}" min="1" class="quantity-input"
                                       data-price="{{ item.price }}" data-id="{{ item.id }}">
                                <span class="item-price">{{ item.price|floatformat:2 }}‚ÇΩ</span>
                                <span class="item-total" id="total_{{ item.id }}">{{ item.price|floatformat:2 }}‚ÇΩ</span>
                            </div>
                            <button type="button" class="remove-btn" onclick="removeItem('{{ item.id }}')">√ó</button>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-cart">–ø–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ</p>
            {% endif %}

            <div class="cart-summary">
                <div class="total">
                    –ò—Ç–æ–≥–æ: <span class="total-amount" id="cart-total">{{ total|floatformat:2 }}‚ÇΩ</span>
                </div>
               <a href="{% url 'receipt' %}" class="time-button" onclick="return saveAllChanges()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</a>
            </div>
        </div>
    </div>

    <script>
        function updateCartItem(input) {
            const dishId = input.getAttribute('data-id');
            const quantity = parseInt(input.value) || 0;
            const price = parseFloat(input.getAttribute('data-price'));

            const totalElement = document.getElementById('total_' + dishId);
            if (totalElement) {
                totalElement.textContent = (quantity * price).toFixed(2) + '‚ÇΩ';
            }

            updateCartTotal();

            updateCartOnServer(dishId, quantity);
        }

        function removeItem(dishId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) {
                updateCartOnServer(dishId, 0);

                const itemElement = document.querySelector(`[data-id="${dishId}"]`).closest('.cart-item');
                if (itemElement) {
                    itemElement.remove();
                }

                updateCartTotal();

                updateItemCount();
            }
        }

        function updateCartTotal() {
            let cartTotal = 0;
            const quantityInputs = document.querySelectorAll('.quantity-input');

            quantityInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.getAttribute('data-price'));
                cartTotal += quantity * price;
            });

            const cartTotalElement = document.getElementById('cart-total');
            if (cartTotalElement) {
                cartTotalElement.textContent = cartTotal.toFixed(2) + '‚ÇΩ';
            }
        }

        function updateItemCount() {
            const itemCount = document.querySelectorAll('.cart-item').length;
            const cartTitle = document.querySelector('.cart-title');
            if (cartTitle) {
                if (itemCount === 0) {
                    cartTitle.textContent = '–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞';
                    const cartItems = document.querySelector('.cart-items');
                    if (cartItems) {
                        cartItems.innerHTML = '<p class="empty-cart">–ø–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ</p>';
                    }
                } else {
                    cartTitle.textContent = `–ö–æ—Ä–∑–∏–Ω–∞ ${itemCount} –ø–æ–∑–∏—Ü–∏–∏`;
                }
            }
        }

        function updateCartOnServer(dishId, quantity) {
            const formData = new FormData();
            formData.append('dish_id', dishId);
            formData.append('quantity', quantity);

            if (quantity <= 0) {
                formData.append('remove', 'true');
            }

            console.log(`Sending to server: dishId=${dishId}, quantity=${quantity}`);

            fetch('{% url "update_cart" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Server response: success', data);
                    const input = document.querySelector(`[data-id="${dishId}"]`);
                    if (input) {
                        input.setAttribute('data-original', quantity);
                    }
                } else {
                    console.error('Server response: error', data.error);
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
            });
        }

        function saveAllChanges() {
            const quantityInputs = document.querySelectorAll('.quantity-input');
            let hasChanges = false;
            let promises = [];

            quantityInputs.forEach(input => {
                const dishId = input.getAttribute('data-id');
                const quantity = parseInt(input.value) || 0;
                const originalQuantity = parseInt(input.getAttribute('data-original')) || 0;

                if (quantity !== originalQuantity) {
                    hasChanges = true;
                    const promise = new Promise((resolve) => {
                        const formData = new FormData();
                        formData.append('dish_id', dishId);
                        formData.append('quantity', quantity);

                        fetch('{% url "update_cart" %}', {
                            method: 'POST',
                            body: formData,
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}'
                            },
                            credentials: 'same-origin'
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                input.setAttribute('data-original', quantity);
                            }
                            resolve();
                        })
                        .catch(() => resolve());
                    });
                    promises.push(promise);
                }
            });

            if (hasChanges && promises.length > 0) {
                Promise.all(promises).then(() => {
                    window.location.href = "{% url 'receipt' %}";
                });
                return false;
            }

            return true;
        }

        window.addEventListener('beforeunload', function(e) {
            const quantityInputs = document.querySelectorAll('.quantity-input');
            let hasUnsavedChanges = false;

            quantityInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const originalQuantity = parseInt(input.getAttribute('data-original')) || 0;

                if (quantity !== originalQuantity) {
                    hasUnsavedChanges = true;
                }
            });

            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω–µ. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–π—Ç–∏?';
                return e.returnValue;
            }
        });

        function setupAutoSave() {
            const quantityInputs = document.querySelectorAll('.quantity-input');

            quantityInputs.forEach(input => {
                input.addEventListener('input', function() {
                    updateCartItem(this);
                });

                input.addEventListener('change', function() {
                    updateCartItem(this);
                });

                input.addEventListener('blur', function() {
                    updateCartItem(this);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const quantityInputs = document.querySelectorAll('.quantity-input');

            quantityInputs.forEach(input => {
                input.setAttribute('data-original', input.value);

                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.getAttribute('data-price'));
                const totalElement = input.parentNode.querySelector('.item-total');
                if (totalElement) {
                    totalElement.textContent = (quantity * price).toFixed(2) + '‚ÇΩ';
                }
            });

            setupAutoSave();

            updateCartTotal();
        });
    </script>
</body>
</html>