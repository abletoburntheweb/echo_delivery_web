<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ—Ä–∑–∏–Ω–∞ | ECHO Corp.</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'core/css/cart.css' %}">
</head>
<body>
    <div class="header">
        <span class="header-title">ECHO Corp.</span>

        {% if work_dates.enabled and work_dates.display_text %}
        <div style="color: white; font-size: 14px; margin: 0 15px;">
            {{ work_dates.display_text }}
        </div>
        {% endif %}

        <div class="header-buttons">
            <span class="unused-button">üìÖ</span>
            <a href="{% url 'profile' %}" class="profile-button">üë§</a>
            <a href="{% url 'faq' %}" class="profile-button">‚ùì</a>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <h2 class="cart-title">–ö–æ—Ä–∑–∏–Ω–∞ {{ item_count }} –ø–æ–∑–∏—Ü–∏–∏</h2>

            <a href="{% url 'menu' %}" class="add-item-btn">+</a>

            {% if cart_items %}
                <div class="cart-items">
                    {% for item in cart_items %}
                        <div class="cart-item">
                            <span class="item-name">{{ item.name }}</span>
                            <div class="quantity-controls">
                                <label for="quantity_{{ item.id }}">–ö–æ–ª-–≤–æ:</label>
                                <input type="number" id="quantity_{{ item.id }}" name="quantity" value="{{ item.quantity }}" min="1" class="quantity-input"
                                       data-price="{{ item.price }}" data-id="{{ item.id }}" onchange="updateCartItem(this)">
                                <span class="item-price">{{ item.price|floatformat:2 }}‚ÇΩ</span>
                                <span class="item-total" id="total_{{ item.id }}">{{ item.price|floatformat:2 }}‚ÇΩ</span>
                            </div>
                            <button type="button" class="remove-btn" onclick="removeItem('{{ item.id }}')">√ó</button>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="empty-cart">–ø–æ–∫–∞ –∑–¥–µ—Å—å –ø—É—Å—Ç–æ</p>
            {% endif %}

            <div class="cart-summary">
                <div class="total">
                    –ò—Ç–æ–≥–æ: <span class="total-amount" id="cart-total">{{ total|floatformat:2 }}‚ÇΩ</span>
                </div>
               <a href="{% url 'receipt' %}" class="time-button">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</a>
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω–µ
        function updateCartItem(input) {
            const dishId = input.getAttribute('data-id');
            const quantity = parseInt(input.value) || 0;
            const price = parseFloat(input.getAttribute('data-price'));

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É–º–º—É –¥–ª—è —Ç–æ–≤–∞—Ä–∞
            const totalElement = document.getElementById('total_' + dishId);
            if (totalElement) {
                totalElement.textContent = (quantity * price).toFixed(2) + '‚ÇΩ';
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É
            updateCartTotal();

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            updateCartOnServer(dishId, quantity);
        }

        // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
        function removeItem(dishId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?')) {
                updateCartOnServer(dishId, 0);

                // –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ DOM
                const itemElement = document.querySelector(`[data-id="${dishId}"]`).closest('.cart-item');
                if (itemElement) {
                    itemElement.remove();
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É
                updateCartTotal();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—â–µ–π —Å—É–º–º—ã –∫–æ—Ä–∑–∏–Ω—ã
        function updateCartTotal() {
            let cartTotal = 0;
            const quantityInputs = document.querySelectorAll('.quantity-input');

            quantityInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.getAttribute('data-price'));
                cartTotal += quantity * price;
            });

            const cartTotalElement = document.getElementById('cart-total');
            if (cartTotalElement) {
                cartTotalElement.textContent = cartTotal.toFixed(2) + '‚ÇΩ';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        function updateCartOnServer(dishId, quantity) {
            const formData = new FormData();
            formData.append('dish_id', dishId);
            formData.append('quantity', quantity);

            if (quantity <= 0) {
                formData.append('remove', 'true');
            }

            fetch('{% url "update_cart" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã');
                }
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞:', error);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—É–º–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            const quantityInputs = document.querySelectorAll('.quantity-input');
            quantityInputs.forEach(input => {
                const quantity = parseInt(input.value) || 0;
                const price = parseFloat(input.getAttribute('data-price'));
                const totalElement = input.parentNode.querySelector('.item-total');
                if (totalElement) {
                    totalElement.textContent = (quantity * price).toFixed(2) + '‚ÇΩ';
                }
            });
            updateCartTotal();
        });
    </script>
</body>
</html>